---
aliases: []
confidence:
created: 2025-11-24T00:22:54Z
epistemic:
journal: Daily
journal-date: 2025-11-24
last_reviewed:
modified: 2025-11-24T10:26:30Z
purpose:
review_interval:
see_also: []
source_of_truth: []
status:
tags: []
title: 2025-11-24
type:
uid:
updated:
---

```journal-nav

```

**Life Day:** 19014
**Life Week:** 2716 (67.9%)
**Life Month:** 624
**Life Year:** 52

---

- Can I still deploy the NNUH Cluster? I think so. I can but try. Should I use targeted modules? Asked Windsurf to give me the order to deploy the resources so I can so it one at a time. Feels more controlled.
   - ps. I used GPT-5.1 high reasoning. It is taking ages. Do I even need high reasoning? It feels as though I always want to use the most intelligent, but that might not be true.
- Why is azure so disorganised? How do we do an incident report on it?
- Deployment order from GPT-5.1
    - [x] `azurerm_subnet.bastion` [completion:: 2025-11-24]
    - [x] `module.private-infrastructure.module.aks_network` + NSGs + NSG associations [completion:: 2025-11-24]
    - [ ] `module.private-infrastructure.module.routetable`? nothing changed
    - [ ] `module.private-infrastructure.module.aks_cluster`
    - [ ] `module.private-infrastructure.module.FITFILEJumpbox`
    - [ ] `module.private-infrastructure.module.bastion_host`
    - [ ] `azurerm_subnet_nat_gateway_association.*`
    - [ ] Final full `terraform plan/apply` (no `-target`).*

Subject: Request for Permission - Access

We’re trying to deploy an AKS cluster via Terraform, and the Terraform service principal (SP) is failing when it attempts to create role assignments.

From the error:

- `AuthorizationFailed: The client '00bcaf85-e7af-4a30-8d22-6d350a425b27' with object id '15159fc0-cd95-45a5-ab05-c3560078d04d' does not have authorization to perform action 'Microsoft.Authorization/roleAssignments/write' over scope '/subscriptions/4ae8fd93-d084-481f-ba6e-370b7d4d8d0d/resourceGroups/rg-ff-uks-gp-net/providers/Microsoft.Authorization/roleAssignments/...`

This tells us:

- Terraform is trying to create an Azure role assignment (in this case, `azurerm_role_assignment.cluster_network_contributor` in the AKS module).
- Creating or updating role assignments in Azure requires the `Microsoft.Authorization/roleAssignments/write` permission at the scope where the assignment is being created (subscription or resource group).
- The Terraform SP does **not** currently have that permission, so the call is rejected with HTTP 403 Forbidden.

To fix this:

- The Terraform SP needs a role that includes `Microsoft.Authorization/roleAssignments/write` at the appropriate scope (typically:
    - **User Access Administrator**,  
        assigned at the subscription or at least the `rg-ff-uks-gp-net` resource group).

Once the SP has one of these roles (or an equivalent custom role) and credentials are refreshed, Terraform will be able to create the required role assignments and the AKS deployment should succeed.

---

If you want, I can also draft this as a formal email with greeting, subject line, etc.

To apply **least privilege permissions for Terraform to create an AKS cluster in a specified VNet**, you should follow these principles:

## 1. Service Principal/Managed Identity Permissions

- The identity Terraform uses **must have enough permissions only to create AKS and interact with required network resources**.

## 2. Minimal Required Azure Roles

- **Network Contributor** on the VNet (or just the specified subnets): Allows Kubernetes networking without giving full Contributor privileges over the resource group.
    - Assign Network Contributor to:
        - The subnet(s) that AKS nodes and API server will use.
        - Any other required network resources (e.g., route tables if explicitly managed).
- **Azure Kubernetes Service Cluster User Role** or **Contributor** (if custom role granularity is not possible) on the AKS resource:
    - This allows the creation and management of AKS clusters, but you can further limit this if you create a more fine-grained custom role.
- **Role Assignment Permissions**
    - To create role assignments (as Terraform does for networking), the identity needs:
        - `Microsoft.Authorization/roleAssignments/write` scoped just to the objects where role assignments are needed (not the entire subscription).

## 3. Example Assignment

bash

```sh
# Create managed identity/service principal 
az identity create --resource-group $RG --name $MI_NAME 
# Assign Network Contributor to subnet for AKS
az role assignment create --assignee $MI_PRINCIPAL_ID --role "Network Contributor" --scope "/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RG/providers/Microsoft.Network/virtualNetworks/$VNET_NAME/subnets/$SUBNET_NAME" 
# (Optional) Assign AKS Cluster User Role on AKS resource
az role assignment create --assignee $MI_PRINCIPAL_ID --role "Azure Kubernetes Service Cluster User Role" --scope "/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RG/providers/Microsoft.ContainerService/managedClusters/$AKS_NAME"
```

## 4. Avoid Over-permission

- **Do not assign Contributor at subscription/resource group level** unless required for other resources.
- If you need to assign roles via Terraform (such as `azurerm_role_assignment`), ensure the identity has `roleAssignments/write` on only the necessary scoped resources.

## Causes of Your Error

- **400 UnmarshalError**: Likely a Terraform misconfiguration—check the values, especially any null or empty required fields (such as `api_server_authorized_ip_ranges`, `service_principal_profile`, or time-formatted values).
- **403 AuthorizationFailed**: Your identity lacks `roleAssignments/write` on the target scope. Grant this permission only as needed for AKS-related role assignments.

## Summary of Recommended Minimal Permissions

|Scope|Role (Least Privilege)|
|---|---|
|VNet Subnet(s) AKS will use|Network Contributor|
|AKS Resource|Azure Kubernetes Service Cluster User/Contributor (custom prefered)|
|Role Assignments (only if needed by Terraform)|Microsoft.Authorization/roleAssignments/write (scoped to subnet/resource only)|

**References:**

- Microsoft docs: [API Server VNet Integration in AKS][learn.microsoft](https://learn.microsoft.com/en-us/azure/aks/api-server-vnet-integration)​
- Microsoft docs: [Custom Role with least privileged permission to install AKS][learn.microsoft](https://learn.microsoft.com/en-us/answers/questions/1726512/custom-role-with-least-privileged-permission-to-in)​
- Azure docs: [Why to assign AKS identity a role in VNET][learn.microsoft](https://learn.microsoft.com/en-us/answers/questions/1273711/why-to-assign-aks-identity-a-role-in-the-vnet)​
- Example Terraform implementation: [Learn docs, quick automatic custom network][learn.microsoft](https://learn.microsoft.com/en-us/azure/aks/automatic/quick-automatic-custom-network)​

If you want to **restrict even further**, consider defining a custom Azure role with just the required permissions for each resource and scope, combining Azure RBAC and Kubernetes RBAC for in-cluster permissions.learn.microsoft+3​
Here is a summary of when the service principal for Terraform was requested and what permissions were discussed, based on the meeting notes and linked documents:

---

## 1. When was the service principal for Terraform requested?

### **First Explicit Request**

- **Date:** 20th January 2025
    
- **Meeting:** NNUH Data and Tech Session
    
- **Source:** [https://fitfileltd.sharepoint.com/:w:/s/FitfileTeam/EXKlC417TuZMoWrQ8UIDaXUBR3ujwH76YWyA4TBvDiFv6Q?e=FCyHxk](https://fitfileltd.sharepoint.com/:w:/s/FitfileTeam/EXKlC417TuZMoWrQ8UIDaXUBR3ujwH76YWyA4TBvDiFv6Q?e=FCyHxk)Preview
    

### **Follow-up and Confirmation**

- **Date:** 8th May 2025
    
- **Meeting:** NNUH FITFILE Tech Discovery Session
    
- **Source:** [https://fitfileltd.sharepoint.com/:w:/s/FitfileTeam/Ec_2BxazBrtBh4HNHqwQc4ABPoeVCgtoLck4FwuxBm_1kQ?e=2nlymR](https://fitfileltd.sharepoint.com/:w:/s/FitfileTeam/Ec_2BxazBrtBh4HNHqwQc4ABPoeVCgtoLck4FwuxBm_1kQ?e=2nlymR)Preview
    

---

## 2. What permissions were requested for the service principal?

### **Permissions/Access Discussed**

- **8th May 2025 Tech Discovery Session:**
    
    - The service principal is to be granted with permissions sufficient for Terraform to deploy infrastructure in the provided Azure subscription.
        
    - There is an emphasis on working with a named engineer to ensure that the virtual networks (VNets) fit with NNUH’s existing hub and spoke networking model.
        
    - No explicit list of Azure RBAC roles is given in the notes, but standard practice for Terraform would require at least "Contributor" access to the relevant resource group or subscription, and possibly "Network Contributor" for VNet changes.
        
- **Other Relevant Details:**
    
    - Remote access to be granted via VPN.
        
    - Change control process for firewall/networking changes.
        
    - Resource quotas and SSL certificate usage to be reviewed during deployment.
        

---

## 3. Supporting Quotes

---

## 4. Links to Source Documents

- (https://onedrive.live.com/favicon.ico)20250120, EofE SDE_NNUH - Data and tech Session - meeting notes.docx](https://fitfileltd.sharepoint.com/:w:/s/FitfileTeam/EXKlC417TuZMoWrQ8UIDaXUBR3ujwH76YWyA4TBvDiFv6Q?e=FCyHxk)Preview
    
- [[](https://onedrive.live.com/favicon.ico)20250508, EofE SDE_NNUH Tech discovery Session - meeting notes.docx](https://fitfileltd.sharepoint.com/:w:/s/FitfileTeam/Ec_2BxazBrtBh4HNHqwQc4ABPoeVCgtoLck4FwuxBm_1kQ?e=2nlymR)Preview
    
- [NNUH - Summary of Meetings and Notes](https://fitfile.atlassian.net/wiki/spaces/EOE/pages/2362834945/NNUH+-+Summary+of+Meetings+and+Notes)Preview
    

---

## 5. Summary Table

|   |   |   |   |
|---|---|---|---|
|Date|Meeting Title|Service Principal Request|Permissions/Access Discussed|
|2025-01-20|NNUH Data and Tech Session|First request by FITFILE|Not specified, but implied for deployment|
|2025-05-08|NNUH FITFILE Tech Discovery Session|Confirmed, with engineer|Sufficient for Terraform, VNet integration|

---

**If you need the exact RBAC roles or a formal permissions list, this may be detailed in the technical packs or security templates referenced in the meetings, but the above is what is captured in the meeting notes.**

Let me know if you need a deeper dive into any specific meeting or further documentation!